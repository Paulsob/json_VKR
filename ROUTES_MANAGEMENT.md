# Управление маршрутами

Система управления маршрутами позволяет добавлять новые маршруты через API без изменения кода.

## Что было сделано

1. **Модель Route в БД** - хранит информацию о маршрутах:
   - Номер маршрута (уникальный)
   - Название маршрута
   - Имена листов в `data.xlsx` для рабочего и выходного дня
   - Пути к файлам расписаний в папке `output/`
   - Статус активности

2. **API endpoints** для управления маршрутами:
   - `GET /api/routes` - получить список всех активных маршрутов
   - `POST /api/routes` - добавить новый маршрут
   - `PUT /api/routes/<id>` - обновить маршрут
   - `DELETE /api/routes/<id>` - деактивировать маршрут
   - `POST /api/routes/upload` - загрузить файлы расписания для маршрута

3. **Автоматическая инициализация** - при первом запуске маршруты 9 и 55 автоматически добавляются в БД

## Как добавить новый маршрут

### Вариант 1: Через API (JSON)

```bash
# 1. Добавить маршрут в БД
curl -X POST http://localhost:5000/api/routes \
  -H "Content-Type: application/json" \
  -d '{
    "route_number": 12,
    "name": "Маршрут 12",
    "sheet_name_workday": "Расписание_рабочего_дня_12",
    "sheet_name_weekend": "Расписание_выходного_дня_12"
  }'

# 2. Загрузить файлы расписания
curl -X POST http://localhost:5000/api/routes/upload \
  -F "route_number=12" \
  -F "file_workday=@Расписание_рабочего_дня_12.xlsx" \
  -F "file_weekend=@Расписание_выходного_дня_12.xlsx"
```

### Вариант 2: Через Python

```python
from structure_model.server import app, db, Route, ensure_db_created
import os

with app.app_context():
    ensure_db_created()
    
    # Создаем маршрут
    route = Route(
        route_number=12,
        name="Маршрут 12",
        sheet_name_workday="Расписание_рабочего_дня_12",
        sheet_name_weekend="Расписание_выходного_дня_12",
        file_workday="Расписание_рабочего_дня_12.xlsx",
        file_weekend="Расписание_выходного_дня_12.xlsx",
        is_active=True
    )
    db.session.add(route)
    db.session.commit()
    
    print(f"Маршрут {route.route_number} добавлен!")
```

## Структура данных маршрута

```json
{
  "id": 1,
  "route_number": 55,
  "name": "Маршрут 55",
  "sheet_name_workday": "Расписание_рабочего_дня_55",
  "sheet_name_weekend": "Расписание_выходного_дня_55",
  "file_workday": "Расписание_рабочего_дня_55.xlsx",
  "file_weekend": "Расписание_выходного_дня_55.xlsx",
  "is_active": true,
  "created_at": "2025-01-XX...",
  "updated_at": "2025-01-XX..."
}
```

## Требования для нового маршрута

1. **В файле `data.xlsx`** должны быть листы с расписаниями:
   - `Расписание_рабочего_дня_{номер}` - для рабочих дней
   - `Расписание_выходного_дня_{номер}` - для выходных дней

2. **В папке `output/`** должны быть файлы:
   - `Расписание_рабочего_дня_{номер}.xlsx`
   - `Расписание_выходного_дня_{номер}.xlsx`

3. **Структура файлов** должна соответствовать существующим (маршруты 9 и 55)

## Что изменилось в коде

- Все жестко прописанные маршруты (9, 55) заменены на динамические из БД
- Функция `get_schedule_sheet_name()` получает имя листа из БД
- При пересчете расписаний используются все активные маршруты из БД
- Маршруты 9 и 55 автоматически добавляются при первом запуске

## Проверка работы

```bash
# Получить список всех маршрутов
curl http://localhost:5000/api/routes

# Проверить, что маршрут используется в расчетах
# Запустить планировщик для нового маршрута через API
curl -X POST http://localhost:5000/api/recalculate/1 \
  -H "Content-Type: application/json" \
  -d '{"route": 12}'
```

